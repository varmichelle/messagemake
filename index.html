<html>
<head>
<title>Chat Room</title>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
<div id="container"></div>
<script src="https://threejs.org/build/three.min.js"></script>
<script id="vertexShader" type="x-shader/x-vertex">
    void main() {
        gl_Position = vec4( position, 1.0 );
    }
</script>
<script id="fragmentShader" type="x-shader/x-fragment">
    uniform vec2 u_resolution;
    uniform float u_time;
    uniform float r;
    uniform float g;
    uniform float b;

    float inv_circle(in vec2 st){
        return distance(st,vec2(0.5)) + distance(st,vec2(0.5));
    }

    float circle(in vec2 st){
        return 1.-inv_circle(st);
    }
    void main() {
        vec2 st = gl_FragCoord.xy/u_resolution.xy;
        vec2 uv = gl_FragCoord.xy / u_resolution.xy - .5 -u_time*.005;
        vec3 c = cos(vec3(u_time*.006,
                      u_time*.025,
                      u_time*.0095)*3.)*2.+2.;
        for (int i = 0; i < 27; i++) {
            vec3 p = vec3(uv*float(i),float(i));
            c += vec3( sin(c.y+sin(p.x)),
                       cos(c.z+sin(p.z)),
                       -sin(c.x+sin(p.y)) );
        }

        vec3 bgcolor = vec3(c*c*.004);
        vec3 circ_color = vec3(r,g,b);
    
        vec3 bg = vec3(inv_circle(st))-bgcolor;
        vec3 color = vec3(circle(st)*circ_color) + vec3(inv_circle(st)*bg);

        gl_FragColor = vec4(color, 1.0);
    }
</script>
    <script>
        var container;
        var camera, scene, renderer;
        var uniforms;

        init();
        animate();

        function init() {
            container = document.getElementById( 'container' );

            camera = new THREE.Camera();
            camera.position.z = 1;

            scene = new THREE.Scene();

            var geometry = new THREE.PlaneBufferGeometry( 2, 2 );

            uniforms = {
                u_time: { type: "f", value: 1.0 },
                u_resolution: { type: "v2", value: new THREE.Vector2() },
                u_mouse: { type: "v2", value: new THREE.Vector2() },
                r: {type: "f", value: 1.0},
                g: {type: "f", value: 1.0},
                b: {type: "f", value: 1.0}
            };

            var material = new THREE.ShaderMaterial( {
                uniforms: uniforms,
                vertexShader: document.getElementById( 'vertexShader' ).textContent,
                fragmentShader: document.getElementById( 'fragmentShader' ).textContent
            } );

            var mesh = new THREE.Mesh( geometry, material );
            scene.add( mesh );

            renderer = new THREE.WebGLRenderer();
            renderer.setPixelRatio( window.devicePixelRatio );

            container.appendChild( renderer.domElement );

            onWindowResize();
            window.addEventListener( 'resize', onWindowResize, false );
        }

        function onWindowResize( event ) {
            renderer.setSize( window.innerWidth, window.innerHeight );
            uniforms.u_resolution.value.x = renderer.domElement.width;
            uniforms.u_resolution.value.y = renderer.domElement.height;
        }

        function animate() {
            requestAnimationFrame( animate );
            render();
        }

        function render() {
            uniforms.u_time.value += 0.05;
            // uniforms.r.value = getRed();
            renderer.render( scene, camera );
        }
    </script>
<script type="text/javascript">
$(document).ready(function() {

    var socket = io.connect('http://5b6b4f64.ngrok.io');

    socket.on('connect', function() {
        socket.send('User has connected!');
    });

    socket.on('message', function(msg) {
        $("#messages").append('<li>'+msg+'</li>');
        console.log('Received message');
        var rgbArr = msg.split(', ');
        uniforms.r.value = parseFloat(rgbArr[0])
        uniforms.g.value = parseFloat(rgbArr[1])
        uniforms.b.value = parseFloat(rgbArr[2])
    });

    $('#sendbutton').on('click', function() {
        socket.send($('#myMessage').val());
        $('#myMessage').val('');
    });

});
</script>
<ul id="messages"></ul>
<input type="text" id="myMessage">
<button id="sendbutton">Send</button>
</body>
</html>